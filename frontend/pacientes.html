<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pacientes - Cl√≠nica Synergy</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Estilos espec√≠ficos para la nueva interfaz de pacientes */
    .pacientes-container {
      display: flex;
      gap: 2rem;
    }

    .pacientes-list-panel {
      width: 400px;
      flex-shrink: 0;
    }

    .pacientes-detail-panel {
      flex-grow: 1;
      display: none; /* Oculto por defecto */
    }

    #search-paciente {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
    }

    .paciente-list {
      list-style: none;
      height: 70vh;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }

    .paciente-list-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .paciente-list-item:hover {
      background-color: #f8f9fa;
    }
    
    .paciente-list-item.active {
      background-color: #e9ecef;
      font-weight: bold;
    }

    .paciente-list-item div {
      font-size: 1.1rem;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }

    .paciente-list-item span {
      font-size: 0.9rem;
      color: #7f8c8d;
    }

    .detail-view-content {
      display: flex;
      gap: 2rem;
    }

    .detail-info {
      flex-basis: 40%;
    }
    
    .detail-history {
      flex-basis: 60%;
    }
    
    .info-group {
      margin-bottom: 1rem;
    }
    
    .info-group label {
      font-weight: 500;
      color: #95a5a6;
      font-size: 0.9rem;
      display: block;
    }

    .info-group p {
      font-size: 1.1rem;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <img 
        src="logo_synergy transparente_blanco.png" 
        alt="Synergy Logo" 
        style="width: 40%; max-width: 350px; margin: 0 auto; display: block;"
      >
    </div>
    <div class="navbar-menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="empleados.html" id="nav-empleados">Empleados</a>
      <a href="pacientes.html" class="active">Pacientes</a>
      <a href="cirugias.html" id="nav-cirugias">Cirug√≠as</a>
      <a href="inventario.html" id="nav-inventario">Inventario</a>
    </div>
    <div class="navbar-user">
      <span id="userName"></span>
      <span id="userRole"></span>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>üë• Gesti√≥n de Pacientes</h2>
      <button class="btn-primary" onclick="mostrarFormularioCrear()">+ Nuevo Paciente</button>
    </div>

    <div class="pacientes-container">
      <div class="pacientes-list-panel card">
        <input type="text" id="search-paciente" placeholder="Buscar por nombre...">
        <ul id="pacientes-list" class="paciente-list">
          <li class="empty-state">Cargando...</li>
        </ul>
      </div>

      <div id="pacientes-detail-panel" class="pacientes-detail-panel">
        <div class="card">
            <div id="detail-view-placeholder" class="empty-state">
                <p>Selecciona un paciente de la lista para ver sus detalles.</p>
            </div>
            <div id="detail-view-data" class="hidden">
              <div class="page-header" style="margin-bottom: 1.5rem;">
                <h3 id="detail-nombre"></h3>
                <div>
                  <button class="btn-edit" id="btn-editar">Editar</button>
                  <button class="btn-delete" id="btn-eliminar">Eliminar</button>
                </div>
              </div>
              <div class="detail-view-content">
                <div class="detail-info">
                  <h4>Datos Personales</h4>
                  <hr class="mb-3">
                  <div class="info-group">
                    <label>ID Paciente</label>
                    <p id="detail-id"></p>
                  </div>
                  <div class="info-group">
                    <label>Sexo</label>
                    <p id="detail-sexo"></p>
                  </div>
                  <div class="info-group">
                    <label>Edad</label>
                    <p id="detail-edad"></p>
                  </div>
                  <div class="info-group">
                    <label>Tel√©fono</label>
                    <p id="detail-telefono"></p>
                  </div>
                  <div class="info-group">
                    <label>Contacto de Emergencia</label>
                    <p id="detail-contacto"></p>
                  </div>
                </div>
                <div class="detail-history">
                  <h4>Historial de Cirug√≠as</h4>
                  <hr class="mb-3">
                  <div class="table-container" style="max-height: 50vh; overflow-y: auto;">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>Fecha</th>
                          <th>Tipo</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody id="historial-cirugias-tbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Nuevo Paciente</h3>
        <span class="close" onclick="cerrarModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="paciente-form">
          <input type="hidden" id="id_paciente">
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" id="nombre" required maxlength="20">
          </div>
          <div class="form-group">
            <label>Apellido Paterno *</label>
            <input type="text" id="paterno" required maxlength="20">
          </div>
          <div class="form-group">
            <label>Apellido Materno</label>
            <input type="text" id="materno" maxlength="20">
          </div>
          <div class="form-group">
            <label>Sexo *</label>
            <select id="sexo" required>
              <option value="">Seleccionar...</option>
              <option value="Masculino">Masculino</option>
              <option value="Femenino">Femenino</option>
            </select>
          </div>
          <div class="form-group">
            <label>Edad *</label>
            <input type="number" id="edad" required min="0" max="120">
          </div>
          <div class="form-group">
            <label>Tel√©fono *</label>
            <input type="tel" id="telefono" required pattern="[0-9]{10}" placeholder="10 d√≠gitos">
          </div>
          <div class="form-group">
            <label>Contacto de Emergencia</label>
            <input type="tel" id="contacto" pattern="[0-9]{10}" placeholder="10 d√≠gitos">
          </div>
          <div class="form-actions">
            <button type="button" onclick="cerrarModal()">Cancelar</button>
            <button type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script src="js/auth.js"></script>
  <script src="js/permisos.js"></script>
  <script src="js/api.js"></script>
  <script>
    // Verificar sesi√≥n y permisos
    verificarSesion();
    if (!PermisosManager.tienePermiso('pacientes')) {
      alert('No tienes permisos para acceder a esta p√°gina');
      window.location.href = 'dashboard.html';
    }

    PermisosManager.aplicarPermisosNavbar();
    PermisosManager.mostrarInfoUsuario();

    let pacientes = [];
    let cirugias = [];
    let modoEdicion = false;
    let pacienteSeleccionadoId = null;

    // Cargar pacientes al iniciar
    async function cargarPacientes() {
      const data = await PacientesAPI.obtenerTodos();
      if (!data) return;
      pacientes = data;
      mostrarPacientesEnLista();
    }

    function mostrarPacientesEnLista(filtro = '') {
      const ul = document.getElementById('pacientes-list');
      const filtroLowerCase = filtro.toLowerCase();

      const pacientesFiltrados = pacientes.filter(p => 
        `${p.nombre} ${p.paterno}`.toLowerCase().includes(filtroLowerCase)
      );

      if (pacientesFiltrados.length === 0) {
        ul.innerHTML = '<li class="empty-state">No se encontraron pacientes.</li>';
        return;
      }

      ul.innerHTML = pacientesFiltrados.map(p => `
        <li class="paciente-list-item ${p.id_paciente === pacienteSeleccionadoId ? 'active' : ''}" onclick="seleccionarPaciente(${p.id_paciente})">
          <div>${p.nombre} ${p.paterno} ${p.materno || ''}</div>
          <span>${p.sexo} - ${p.edad} a√±os</span>
        </li>
      `).join('');
    }

    async function seleccionarPaciente(id) {
        pacienteSeleccionadoId = id;
        mostrarPacientesEnLista(document.getElementById('search-paciente').value); // Resalta el item activo
        
        const detailPanel = document.getElementById('pacientes-detail-panel');
        const placeholder = document.getElementById('detail-view-placeholder');
        const dataView = document.getElementById('detail-view-data');

        // Mostrar panel y loading
        detailPanel.style.display = 'block';
        placeholder.classList.remove('hidden');
        placeholder.innerHTML = '<p>Cargando detalles...</p>';
        dataView.classList.add('hidden');

        // Cargar datos del paciente y su historial
        const paciente = await PacientesAPI.obtenerPorId(id);
        const todasLasCirugias = await CirugiasAPI.obtenerTodas();
        
        if (!paciente || !todasLasCirugias) {
            placeholder.innerHTML = '<p>Error al cargar los datos del paciente.</p>';
            return;
        }

        const historial = todasLasCirugias.filter(c => c.id_paciente === id);

        // Poblar vista de detalles
        document.getElementById('detail-id').textContent = paciente.id_paciente;
        document.getElementById('detail-nombre').textContent = `${paciente.nombre} ${paciente.paterno}`;
        document.getElementById('detail-sexo').textContent = paciente.sexo;
        document.getElementById('detail-edad').textContent = `${paciente.edad} a√±os`;
        document.getElementById('detail-telefono').textContent = paciente.telefono;
        document.getElementById('detail-contacto').textContent = paciente.contacto || 'No registrado';
        
        document.getElementById('btn-editar').onclick = () => editarPaciente(id);
        document.getElementById('btn-eliminar').onclick = () => eliminarPaciente(id);

        // Poblar historial de cirug√≠as
        const historialTbody = document.getElementById('historial-cirugias-tbody');
        if(historial.length > 0) {
            historialTbody.innerHTML = historial.map(c => `
                <tr>
                    <td>${new Date(c.fecha_inicio).toLocaleDateString('es-MX')}</td>
                    <td>${c.tipo_nombre || 'No especificado'}</td>
                    <td>${c.estado}</td>
                </tr>
            `).join('');
        } else {
            historialTbody.innerHTML = '<tr><td colspan="3" class="text-center">Sin cirug√≠as registradas.</td></tr>';
        }

        // Mostrar datos y ocultar placeholder
        placeholder.classList.add('hidden');
        dataView.classList.remove('hidden');
    }

    // L√≥gica para el buscador
    document.getElementById('search-paciente').addEventListener('input', (e) => {
        mostrarPacientesEnLista(e.target.value);
    });
    
    // ----- L√≥gica del Modal -----
    function mostrarFormularioCrear() {
      modoEdicion = false;
      document.getElementById('modal-title').textContent = 'Nuevo Paciente';
      document.getElementById('paciente-form').reset();
      document.getElementById('id_paciente').value = '';
      document.getElementById('modal').style.display = 'block';
    }

    async function editarPaciente(id) {
      const paciente = pacientes.find(p => p.id_paciente == id);
      if (!paciente) return;

      modoEdicion = true;
      document.getElementById('modal-title').textContent = 'Editar Paciente';
      document.getElementById('id_paciente').value = paciente.id_paciente;
      document.getElementById('nombre').value = paciente.nombre;
      document.getElementById('paterno').value = paciente.paterno;
      document.getElementById('materno').value = paciente.materno || '';
      document.getElementById('sexo').value = paciente.sexo;
      document.getElementById('edad').value = paciente.edad;
      document.getElementById('telefono').value = paciente.telefono;
      document.getElementById('contacto').value = paciente.contacto || '';

      document.getElementById('modal').style.display = 'block';
    }

    async function eliminarPaciente(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este paciente?')) return;

      const resultado = await PacientesAPI.eliminar(id);
      if (resultado) {
        alert('Paciente eliminado correctamente');
        pacienteSeleccionadoId = null;
        document.getElementById('pacientes-detail-panel').style.display = 'none';
        cargarPacientes();
      }
    }

    function cerrarModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // Submit del formulario
    document.getElementById('paciente-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            nombre: document.getElementById('nombre').value,
            paterno: document.getElementById('paterno').value,
            materno: document.getElementById('materno').value || null,
            sexo: document.getElementById('sexo').value,
            edad: parseInt(document.getElementById('edad').value),
            telefono: document.getElementById('telefono').value,
            contacto: document.getElementById('contacto').value || null,
            creado: new Date().toISOString() // A√±adir fecha de creaci√≥n
        };

        let resultado;

        if (modoEdicion) {
            const id = document.getElementById('id_paciente').value;
            resultado = await PacientesAPI.actualizar(id, formData);
            if (resultado) alert('Paciente actualizado correctamente');
        } else {
            resultado = await PacientesAPI.crear(formData);
            if (resultado) alert('Paciente creado correctamente');
        }

        if (resultado) {
            cerrarModal();
            cargarPacientes();
            // Si se estaba viendo un paciente, se actualiza su vista
            if (pacienteSeleccionadoId) {
                seleccionarPaciente(pacienteSeleccionadoId);
            }
        }
    });

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target == modal) cerrarModal();
    }
    
    // Carga inicial
    cargarPacientes();
  </script>
</body>
</html>