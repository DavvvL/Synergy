<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empleados - Cl√≠nica Synergy</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .badge-activo { 
      background: #27ae60; 
      color: white; 
      padding: 0.3rem 0.8rem; 
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .badge-inactivo { 
      background: #95a5a6; 
      color: white; 
      padding: 0.3rem 0.8rem; 
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .puesto-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      text-transform: capitalize;
    }
    .puesto-admin { background: #9b59b6; color: white; }
    .puesto-doctor { background: #3498db; color: white; }
    .puesto-enfermeroa { background: #1abc9c; color: white; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <img 
        src="logo_synergy transparente_blanco.png" 
        alt="Synergy Logo" 
        style="width: 40%; max-width: 350px; margin: 0 auto; display: block;"
      >
    </div>
    <div class="navbar-menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="empleados.html" class="active">Empleados</a>
      <a href="pacientes.html" id="nav-pacientes">Pacientes</a>
      <a href="cirugias.html" id="nav-cirugias">Cirug√≠as</a>
      <a href="inventario.html" id="nav-inventario">Inventario</a>
    </div>
    <div class="navbar-user">
      <span id="userName"></span>
      <span id="userRole"></span>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>üë• Gesti√≥n de Empleados</h2>
      <button class="btn-primary" onclick="mostrarModalEmpleado(false)">+ Nuevo Empleado</button>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre Completo</th>
            <th>Correo</th>
            <th>Puesto</th>
            <th>Turno</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="empleados-tbody">
          <tr><td colspan="7" class="text-center">Cargando...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="admin-equipos-section" class="hidden">
      <hr style="margin: 3rem 0;">
      <div class="page-header">
        <h2>üõ†Ô∏è Gesti√≥n de Equipos</h2>
        <button class="btn-primary" onclick="mostrarModalEquipo(false)">+ Nuevo Equipo</button>
      </div>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre del Equipo</th>
              <th>Descripci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="equipos-tbody"></tbody>
        </table>
      </div>
    </div>
    </div>

  <div id="modal-empleado" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="empleado-modal-title">Nuevo Empleado</h3>
        <span class="close" onclick="cerrarModalEmpleado()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="empleado-form">
          <input type="hidden" id="id_empleado">
          <div class="form-group"><label>Nombre *</label><input type="text" id="nombre" required maxlength="25"></div>
          <div class="form-group"><label>Apellido Paterno *</label><input type="text" id="paterno" required maxlength="25"></div>
          <div class="form-group"><label>Apellido Materno *</label><input type="text" id="materno" required maxlength="25"></div>
          <div class="form-group"><label>Correo *</label><input type="email" id="correo" required maxlength="40"></div>
          <div class="form-group"><label>Contrase√±a *</label><input type="password" id="contrase√±a" required maxlength="30" placeholder="Dejar en blanco para no cambiar"></div>
          <div class="form-group"><label>Puesto *</label><select id="puesto" required></select></div>
          <div class="form-group"><label>Turno *</label><select id="turno" required><option value="">Seleccionar...</option><option value="Matutino">Matutino</option><option value="Vespertino">Vespertino</option><option value="Nocturno">Nocturno</option></select></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="telefono" pattern="[0-9]{10}" placeholder="10 d√≠gitos"></div>
          <div class="form-group"><label>Equipo *</label><select id="id_equipo" required></select></div>
          <div class="form-group"><label><input type="checkbox" id="activo" checked>Activo</label></div>
          <div class="form-actions">
            <button type="button" onclick="cerrarModalEmpleado()">Cancelar</button>
            <button type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="modal-equipo" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="equipo-modal-title">Nuevo Equipo</h3>
        <span class="close" onclick="cerrarModalEquipo()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="equipo-form">
          <input type="hidden" id="id_equipo_form">
          <div class="form-group">
            <label>Nombre del Equipo *</label>
            <input type="text" id="nombre_equipo_form" required maxlength="20">
          </div>
          <div class="form-group">
            <label>Descripci√≥n</label>
            <textarea id="descripcion_equipo_form" maxlength="50" rows="3"></textarea>
          </div>
          <div class="form-actions">
            <button type="button" onclick="cerrarModalEquipo()">Cancelar</button>
            <button type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/permisos.js"></script>
  <script src="js/api.js"></script>
  <script>
    verificarSesion();
    if (!PermisosManager.esAdmin()) {
      alert('Solo los administradores pueden acceder a esta p√°gina');
      window.location.href = 'dashboard.html';
    }
    PermisosManager.aplicarPermisosNavbar();
    PermisosManager.mostrarInfoUsuario();

    let empleados = [], puestos = [], equipos = [];
    let modoEdicionEmpleado = false, modoEdicionEquipo = false;

    async function cargarDatos() {
      await Promise.all([cargarEmpleados(), cargarPuestos(), cargarEquipos()]);
      if (PermisosManager.esAdmin()) {
        document.getElementById('admin-equipos-section').classList.remove('hidden');
        mostrarEquiposEnTabla();
      }
    }
    
    // --- L√ìGICA DE EMPLEADOS ---
    async function cargarEmpleados() {
      empleados = await EmpleadosAPI.obtenerTodos();
      if (!empleados) return;
      mostrarEmpleadosEnTabla();
    }
    
    function clasePuesto(puesto) {
        if (!puesto) return '';
        return `puesto-${puesto.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
    }

    function mostrarEmpleadosEnTabla() {
      const tbody = document.getElementById('empleados-tbody');
      tbody.innerHTML = empleados.map(e => `
        <tr>
          <td>${e.id_empleado}</td>
          <td>${e.nombre} ${e.paterno} ${e.materno}</td>
          <td>${e.correo}</td>
          <td><span class="puesto-badge ${clasePuesto(e.puesto)}">${e.puesto}</span></td>
          <td>${e.turno}</td>
          <td><span class="${e.activo ? 'badge-activo' : 'badge-inactivo'}">${e.activo ? 'Activo' : 'Inactivo'}</span></td>
          <td>
            <button class="btn-edit" onclick="mostrarModalEmpleado(true, ${e.id_empleado})">Editar</button>
            <button class="btn-delete" onclick="eliminarEmpleado(${e.id_empleado})">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }
    
    function mostrarModalEmpleado(esEdicion, id = null) {
      modoEdicionEmpleado = esEdicion;
      const form = document.getElementById('empleado-form');
      form.reset();
      
      if (esEdicion) {
        const empleado = empleados.find(e => e.id_empleado === id);
        if (!empleado) return;
        document.getElementById('empleado-modal-title').textContent = 'Editar Empleado';
        document.getElementById('id_empleado').value = empleado.id_empleado;
        document.getElementById('nombre').value = empleado.nombre;
        document.getElementById('paterno').value = empleado.paterno;
        document.getElementById('materno').value = empleado.materno;
        document.getElementById('correo').value = empleado.correo;
        document.getElementById('contrase√±a').required = false;
        document.getElementById('puesto').value = empleado.puesto;
        document.getElementById('turno').value = empleado.turno;
        document.getElementById('telefono').value = empleado.telefono || '';
        document.getElementById('id_equipo').value = empleado.id_equipo;
        document.getElementById('activo').checked = empleado.activo === true;
      } else {
        document.getElementById('empleado-modal-title').textContent = 'Nuevo Empleado';
        document.getElementById('id_empleado').value = '';
        document.getElementById('contrase√±a').required = true;
      }
      document.getElementById('modal-empleado').style.display = 'block';
    }
    
    function cerrarModalEmpleado() {
      document.getElementById('modal-empleado').style.display = 'none';
    }
    
    async function eliminarEmpleado(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este empleado?')) return;
      const resultado = await EmpleadosAPI.eliminar(id);
      if (resultado) {
        alert('Empleado eliminado correctamente');
        cargarEmpleados();
      }
    }
    
    async function cargarPuestos() {
      puestos = await EmpleadosAPI.obtenerPuestos();
      if (!puestos) return;
      const select = document.getElementById('puesto');
      select.innerHTML = '<option value="">Seleccionar puesto...</option>' +
        puestos.map(p => `<option value="${p.puesto}">${p.puesto}</option>`).join('');
    }

    // --- L√ìGICA DE EQUIPOS ---
    async function cargarEquipos() {
      equipos = await EmpleadosAPI.obtenerEquipos();
      if (!equipos) return;
      const select = document.getElementById('id_equipo');
      select.innerHTML = '<option value="">Seleccionar equipo...</option>' +
        equipos.map(e => `<option value="${e.id_equipo}">${e.nombre_equipo}</option>`).join('');
    }

    function mostrarEquiposEnTabla() {
      const tbody = document.getElementById('equipos-tbody');
      tbody.innerHTML = equipos.map(e => `
        <tr>
          <td>${e.id_equipo}</td>
          <td>${e.nombre_equipo}</td>
          <td>${e.descripcion || 'N/A'}</td>
          <td>
            <button class="btn-edit" onclick="mostrarModalEquipo(true, ${e.id_equipo})">Editar</button>
            <button class="btn-delete" onclick="eliminarEquipo(${e.id_equipo})">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    function mostrarModalEquipo(esEdicion, id = null) {
      modoEdicionEquipo = esEdicion;
      const form = document.getElementById('equipo-form');
      form.reset();
      
      if (esEdicion) {
        const equipo = equipos.find(e => e.id_equipo === id);
        if (!equipo) return;
        document.getElementById('equipo-modal-title').textContent = 'Editar Equipo';
        document.getElementById('id_equipo_form').value = equipo.id_equipo;
        document.getElementById('nombre_equipo_form').value = equipo.nombre_equipo;
        document.getElementById('descripcion_equipo_form').value = equipo.descripcion || '';
      } else {
        document.getElementById('equipo-modal-title').textContent = 'Nuevo Equipo';
        document.getElementById('id_equipo_form').value = '';
      }
      document.getElementById('modal-equipo').style.display = 'block';
    }

    function cerrarModalEquipo() {
      document.getElementById('modal-equipo').style.display = 'none';
    }

    async function eliminarEquipo(id) {
      if (!confirm('¬øEst√°s seguro de eliminar este equipo? No se podr√° eliminar si hay empleados o cirug√≠as asignadas a √©l.')) return;
      const resultado = await EmpleadosAPI.eliminarEquipo(id);
      if (resultado) {
        alert('Equipo eliminado correctamente.');
        await cargarEquipos();
        mostrarEquiposEnTabla();
      }
    }
    
    // --- EVENT LISTENERS ---
    document.getElementById('empleado-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        nombre: document.getElementById('nombre').value,
        paterno: document.getElementById('paterno').value,
        materno: document.getElementById('materno').value,
        correo: document.getElementById('correo').value,
        puesto: document.getElementById('puesto').value,
        turno: document.getElementById('turno').value,
        telefono: document.getElementById('telefono').value,
        id_equipo: parseInt(document.getElementById('id_equipo').value),
        activo: document.getElementById('activo').checked
      };
      const contrase√±a = document.getElementById('contrase√±a').value;
      if (contrase√±a) formData.contrase√±a = contrase√±a;
      
      let resultado;
      if (modoEdicionEmpleado) {
        const id = document.getElementById('id_empleado').value;
        resultado = await EmpleadosAPI.actualizar(id, formData);
        if (resultado) alert('Empleado actualizado correctamente.');
      } else {
        resultado = await EmpleadosAPI.crear(formData);
        if (resultado) alert('Empleado creado correctamente.');
      }
      if (resultado) {
        cerrarModalEmpleado();
        cargarEmpleados();
      }
    });

    document.getElementById('equipo-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('id_equipo_form').value;
      const formData = {
        nombre_equipo: document.getElementById('nombre_equipo_form').value,
        descripcion: document.getElementById('descripcion_equipo_form').value || null
      };
      let resultado;
      if (modoEdicionEquipo) {
        resultado = await EmpleadosAPI.actualizarEquipo(id, formData);
        if (resultado) alert('Equipo actualizado correctamente.');
      } else {
        resultado = await EmpleadosAPI.crearEquipo(formData);
        if (resultado) alert('Equipo creado correctamente.');
      }
      if (resultado) {
        cerrarModalEquipo();
        await cargarEquipos();
        mostrarEquiposEnTabla();
      }
    });

    cargarDatos();
  </script>
</body>
</html>