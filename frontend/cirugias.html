<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horario de Cirug√≠as - Cl√≠nica Synergy</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Estilos para el nuevo horario */
    .schedule-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .schedule-controls input[type="date"] {
      padding: 0.5rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
    }

    .schedule-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .schedule-grid {
      display: flex;
      min-width: 800px;
    }

    .time-column {
      flex: 0 0 80px;
      padding-top: 40px;
    }

    .time-label {
      height: 60px;
      text-align: center;
      color: #95a5a6;
      font-size: 0.9rem;
      position: relative;
    }
    .time-label::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 10%;
      width: 80%;
      height: 1px;
      background: #f0f0f0;
    }

    .schedule-column {
      flex: 1;
      border-left: 1px solid #f0f0f0;
      position: relative;
    }

    .schedule-header {
      text-align: center;
      padding: 0.75rem;
      font-weight: 600;
      color: #2c3e50;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      height: 40px;
    }

    .surgery-block {
      position: absolute;
      width: 90%;
      left: 5%;
      background-color: #3498db;
      color: white;
      border-radius: 8px;
      padding: 0.5rem;
      font-size: 0.85rem;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .surgery-block:hover {
      background-color: #2980b9;
      transform: scale(1.02);
      z-index: 20;
    }
    .surgery-block .title { font-weight: bold; }

    /* Estilos para el formulario del modal */
    .step { display: none; }
    
    .view-mode-content, .edit-mode-content, .creacion-mode {
      display: none;
    }
    /* 2. Mostrar solo el contenedor correspondiente al modo del modal */
    .modal.view-mode .view-mode-content { display: block; }
    .modal.edit-mode .edit-mode-content { display: block; }
    .modal.creacion-mode .creacion-mode { display: block; }

    /* 3. Dentro del modo creaci√≥n, ocultar los pasos por defecto */
    .creacion-mode .step {
      display: none;
    }
    /* 4. Mostrar solo el paso que tenga la clase 'active' */
    .creacion-mode .step.active {
      display: block;
    }

    #horas-disponibles-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    #horas-disponibles-container button {
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #fff;
      transition: all 0.2s;
    }

    #horas-disponibles-container button:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    #horas-disponibles-container button:disabled {
      background: #f0f0f0;
      color: #ccc;
      cursor: not-allowed;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .info-group {
      margin-bottom: 1rem;
    }
    
    .info-group label {
      font-weight: 500;
      color: #95a5a6;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .info-group p {
      font-size: 1.1rem;
      color: #2c3e50;
      margin: 0;
    }

    .searchable-select-container {
      position: relative;
    }
    .searchable-select-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .searchable-select-dropdown .item {
      padding: 0.75rem;
      cursor: pointer;
    }
    .searchable-select-dropdown .item:hover {
      background-color: #f8f9fa;
    }
    .searchable-select-dropdown .empty {
      padding: 0.75rem;
      color: #95a5a6;
    }
    .creacion-mode #step1.active, .creacion-mode #step2.active { display: block; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <img 
        src="logo_synergy transparente_blanco.png" 
        alt="Synergy Logo" 
        style="width: 40%; max-width: 350px; margin: 0 auto; display: block;"
      >
    </div>
    <div class="navbar-menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="empleados.html" id="nav-empleados">Empleados</a>
      <a href="pacientes.html" id="nav-pacientes">Pacientes</a>
      <a href="cirugias.html" class="active">Cirug√≠as</a>
      <a href="inventario.html" id="nav-inventario">Inventario</a>
    </div>
    <div class="navbar-user">
      <span id="userName"></span>
      <span id="userRole"></span>
      <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </nav>

  <div class="container">
    <div class="schedule-controls">
      <div class="page-header" style="margin: 0;"><h2>üóìÔ∏è Horario de Quir√≥fanos</h2></div>
      <div>
        <input type="date" id="date-picker">
        <button class="btn-primary" onclick="mostrarModalCreacion()">+ Agendar Cirug√≠a</button>
      </div>
    </div>
    <div id="schedule-container" class="schedule-container"></div>
  </div>

  <div id="modal-cirugia" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="cirugia-modal-title">Detalles</h3>
        <span class="close" onclick="cerrarModalCirugia()">&times;</span>
      </div>
      <div class="modal-body">
        
        <div class="view-mode-content">
          <div class="detail-grid">
            <div class="info-group"><label>Paciente</label><p id="view-paciente"></p></div>
            <div class="info-group"><label>Tipo de Cirug√≠a</label><p id="view-tipo"></p></div>
            <div class="info-group"><label>Fecha y Hora de Inicio</label><p id="view-fecha-inicio"></p></div>
            <div class="info-group"><label>Fecha de Fin Estimada</label><p id="view-fecha-fin"></p></div>
            <div class="info-group"><label>Quir√≥fano</label><p id="view-quirofano"></p></div>
            <div class="info-group"><label>Equipo</label><p id="view-equipo"></p></div>
            <div class="info-group"><label>Estado</label><p id="view-estado"></p></div>
          </div>
          <div class="info-group"><label>Motivo</label><p id="view-motivo"></p></div>
          <div class="info-group"><label>Descripci√≥n</label><p id="view-descripcion"></p></div>
          <div class="form-actions">
            <button type="button" class="btn-delete" id="btn-eliminar-vista">Eliminar</button>
            <button type="button" class="btn-primary" id="btn-ir-a-editar">Editar Cirug√≠a</button>
          </div>
        </div>

        <div class="edit-mode-content">
          <form id="cirugia-form-editar">
            <input type="hidden" id="id_cirugia_editar">
            <div class="form-group">
              <label>Fecha y Hora de Inicio *</label>
              <input type="datetime-local" id="fecha_inicio_editar" required>
            </div>
            <div class="form-group">
              <label>Paciente *</label>
              <div class="searchable-select-container" id="paciente-search-editar-container">
                <input type="text" id="paciente-search-editar" class="searchable-input" autocomplete="off" placeholder="Buscar por nombre...">
                <input type="hidden" id="id_paciente_editar" required>
                <div class="searchable-select-dropdown"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Equipo *</label>
              <select id="id_equipo_editar" required></select>
            </div>
            <div class="form-group">
              <label>Tipo de Cirug√≠a *</label>
              <select id="id_tipo_cirugia_editar" required></select>
            </div>
            <div class="form-group">
              <label>Quir√≥fano *</label>
              <select id="id_quirofano_editar" required></select>
            </div>
            <div class="form-group">
              <label>Motivo *</label>
              <input type="text" id="motivo_editar" required maxlength="60">
            </div>
            <div class="form-group">
              <label>Descripci√≥n</label>
              <textarea id="descripcion_editar" maxlength="255" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>Estado *</label>
              <select id="estado_editar" required>
                <option value="Programada">Programada</option>
                <option value="Progreso">En Progreso</option>
                <option value="Finalizada">Finalizada</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="button" onclick="mostrarDetallesCirugia()">Volver a Detalles</button>
              <button type="submit">Guardar Cambios</button>
            </div>
          </form>
        </div>

        <div class="creacion-mode">
          <form id="cirugia-form-crear">
            <div id="step1" class="step">
              <div class="form-group">
                <label>1. Seleccione el Tipo de Cirug√≠a *</label>
                <select id="id_tipo_cirugia_crear"></select>
              </div>
              <div class="form-group">
                <label>2. Seleccione el Quir√≥fano *</label>
                <select id="id_quirofano_crear"></select>
              </div>
              <div id="horas-disponibles-container"></div>
            </div>
            <div id="step2" class="step">
              <input type="hidden" id="fecha_inicio_hidden">
              <p><strong>Fecha y Hora seleccionada:</strong> <span id="fecha-hora-seleccionada"></span></p>
              <hr class="mb-3">
              <div class="form-group">
                <label>Paciente *</label>
                <div class="searchable-select-container" id="paciente-search-crear-container">
                  <input type="text" id="paciente-search-crear" class="searchable-input" autocomplete="off" placeholder="Buscar por nombre...">
                  <input type="hidden" id="id_paciente_crear">
                  <div class="searchable-select-dropdown"></div>
                </div>
              </div>
              <div class="form-group">
                <label>Equipo *</label>
                <select id="id_equipo_crear"></select>
              </div>
              <div class="form-group">
                <label>Motivo *</label>
                <input type="text" id="motivo_crear" maxlength="60">
              </div>
              <div class="form-actions">
                <button type="button" onclick="volverAPaso1()">Atr√°s</button>
                <button type="submit">Agendar Cirug√≠a</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  
  
  <script src="js/auth.js"></script>
  <script src="js/permisos.js"></script>
  <script src="js/api.js"></script>
  <script>
    // --- L√≥gica de Autenticaci√≥n y Permisos ---
    verificarSesion();
    PermisosManager.aplicarPermisosNavbar();
    PermisosManager.mostrarInfoUsuario();

    // --- Variables Globales ---
    let cirugias = [];
    let quirofanos = [];
    let tiposCirugia = [];
    let equipos = [];
    let pacientes = [];
    let currentDate = new Date();
    let modoEdicionCirugia = false;

    // --- L√≥gica de Carga de Datos ---
    async function cargarDatos() {
      const datePicker = document.getElementById('date-picker');
      currentDate = new Date(datePicker.value + 'T00:00:00'); 
      
      const [dataCirugias, dataQuirofanos, dataTipos, dataEquipos, dataPacientes] = await Promise.all([
        CirugiasAPI.obtenerTodas(),
        CirugiasAPI.obtenerQuirofanos(),
        CirugiasAPI.obtenerTipos(),
        EmpleadosAPI.obtenerEquipos(),
        PacientesAPI.obtenerTodos()
      ]);

      cirugias = dataCirugias || [];
      quirofanos = dataQuirofanos || [];
      tiposCirugia = dataTipos || [];
      equipos = dataEquipos || [];
      pacientes = dataPacientes || [];
      
      renderSchedule();
      poblarSelectsModal();
    }

    // --- L√≥gica de Renderizado del Horario ---
    function renderSchedule() {
      const container = document.getElementById('schedule-container');
      const cirugiasDelDia = cirugias.filter(c => new Date(c.fecha_inicio).toDateString() === currentDate.toDateString());
      let gridHTML = '<div class="schedule-grid">';
      gridHTML += '<div class="time-column">';
      for(let i = 0; i < 24; i++){ gridHTML += `<div class="time-label">${i}:00</div>`; }
      gridHTML += '</div>';
      quirofanos.forEach(q => {
        gridHTML += `<div class="schedule-column"><div class="schedule-header">${q.nombre}</div>`;
        const cirugiasEnQuirofano = cirugiasDelDia.filter(c => c.id_quirofano === q.id_quirofano);
        cirugiasEnQuirofano.forEach(c => {
          const tipo = tiposCirugia.find(t => t.id_tipo_cirugia === c.id_tipo_cirugia);
          const duracionHoras = tipo ? tipo.horas : 1;
          const fechaInicio = new Date(c.fecha_inicio);
          const horaInicio = fechaInicio.getHours();
          const minutoInicio = fechaInicio.getMinutes();
          const topPosition = (horaInicio * 60) + minutoInicio + 60;
          const blockHeight = duracionHoras * 60;
          
          gridHTML += `
            <div class="surgery-block" style="top: ${topPosition}px; height: ${blockHeight}px;" onclick="mostrarDetallesCirugia(${c.id_cirugia})">
              <div class="title">${c.tipo_nombre || 'Cirug√≠a'}</div>
              <div>Paciente: ${c.paciente_nombre} ${c.paciente_paterno}</div>
            </div>
          `;
        });
        gridHTML += `</div>`;
      });
      gridHTML += `</div>`;
      container.innerHTML = gridHTML;
    }

    function mostrarDetallesCirugia(id) {
      if (id === undefined && cirugiaSeleccionadaId !== null) {
        id = cirugiaSeleccionadaId;
      } else {
        cirugiaSeleccionadaId = id;
      }

      const cirugia = cirugias.find(c => c.id_cirugia === id);
      if (!cirugia) return;

      const modal = document.getElementById('modal-cirugia');
      modal.classList.add('view-mode');
      modal.classList.remove('edit-mode', 'creacion-mode');
      document.getElementById('cirugia-modal-title').textContent = 'Detalles de la Cirug√≠a';

      const fechaInicio = new Date(cirugia.fecha_inicio);
      const tipo = tiposCirugia.find(t => t.id_tipo_cirugia === cirugia.id_tipo_cirugia);
      const duracionHoras = tipo ? tipo.horas : 1;
      
      // Se calcula la fecha de fin sumando los milisegundos de la duraci√≥n
      // 1 hora = 60 min * 60 seg * 1000 ms
      const fechaFin = new Date(fechaInicio.getTime() + duracionHoras * 60 * 60 * 1000);

      document.getElementById('view-paciente').textContent = `${cirugia.paciente_nombre} ${cirugia.paciente_paterno}`;
      document.getElementById('view-fecha-inicio').textContent = fechaInicio.toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
      document.getElementById('view-fecha-fin').textContent = fechaFin.toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' }); // <-- Mostrar fecha de fin
      document.getElementById('view-tipo').textContent = cirugia.tipo_nombre;
      document.getElementById('view-quirofano').textContent = cirugia.quirofano_nombre;
      document.getElementById('view-equipo').textContent = cirugia.nombre_equipo;
      document.getElementById('view-estado').textContent = cirugia.estado;
      document.getElementById('view-motivo').textContent = cirugia.motivo || 'N/A';
      document.getElementById('view-descripcion').textContent = cirugia.descripcion || 'Sin descripci√≥n.';
      
      document.getElementById('btn-ir-a-editar').onclick = () => entrarModoEdicion();
      document.getElementById('btn-eliminar-vista').onclick = () => eliminarCirugia(id);
      
      modal.style.display = 'block';
    }

    function entrarModoEdicion() {
      const cirugia = cirugias.find(c => c.id_cirugia === cirugiaSeleccionadaId);
      if (!cirugia) return;

      const modal = document.getElementById('modal-cirugia');
      modal.classList.remove('view-mode', 'creacion-mode');
      modal.classList.add('edit-mode');
      document.getElementById('cirugia-modal-title').textContent = 'Editar Cirug√≠a';

      const paciente = pacientes.find(p => p.id_paciente === cirugia.id_paciente);
      document.getElementById('paciente-search-editar').value = paciente ? `${paciente.nombre} ${paciente.paterno}` : '';
      document.getElementById('id_paciente_editar').value = cirugia.id_paciente;

      document.getElementById('id_cirugia_editar').value = cirugia.id_cirugia;
      document.getElementById('id_paciente_editar').value = cirugia.id_paciente;
      document.getElementById('id_equipo_editar').value = cirugia.id_equipo;
      document.getElementById('id_tipo_cirugia_editar').value = cirugia.id_tipo_cirugia;
      document.getElementById('id_quirofano_editar').value = cirugia.id_quirofano;
      document.getElementById('motivo_editar').value = cirugia.motivo || '';
      document.getElementById('descripcion_editar').value = cirugia.descripcion || '';
      document.getElementById('estado_editar').value = cirugia.estado;
      
      const fecha = new Date(cirugia.fecha_inicio);
      const fechaLocal = new Date(fecha.getTime() - fecha.getTimezoneOffset() * 60000);
      document.getElementById('fecha_inicio_editar').value = fechaLocal.toISOString().slice(0, 16);
    }
    
    function mostrarModalCreacion() {
      const modal = document.getElementById('modal-cirugia');
      modal.classList.remove('view-mode', 'edit-mode');
      modal.classList.add('creacion-mode');
      document.getElementById('cirugia-modal-title').textContent = 'Agendar Nueva Cirug√≠a';
      
      document.getElementById('cirugia-form-crear').reset();
      document.getElementById('horas-disponibles-container').innerHTML = '<p class="text-muted">Seleccione tipo y quir√≥fano para ver horas.</p>';
      
      // Asegurarse de que el Paso 1 sea el activo y sus campos sean requeridos
      volverAPaso1();
      
      modal.style.display = 'block';
    }
    
    function cerrarModalCirugia() {
      document.getElementById('modal-cirugia').style.display = 'none';
      cirugiaSeleccionadaId = null;
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.remove('active');
    }
    
    async function eliminarCirugia(id) {
      if (!confirm('¬øEst√°s seguro de eliminar esta cirug√≠a?')) return;
      const resultado = await CirugiasAPI.eliminar(id);
      if (resultado) {
        alert('Cirug√≠a eliminada correctamente');
        cerrarModalCirugia();
        cargarDatos();
      }
    }

    function setupSearchableSelect(containerId) {
      const container = document.getElementById(containerId);
      // **AQU√ç OCURR√çA EL ERROR**: container era null
      if (!container) return; // A√±adir esta guarda para seguridad
      
      const searchInput = container.querySelector('.searchable-input');
      const hiddenInput = container.querySelector('input[type="hidden"]');
      const dropdown = container.querySelector('.searchable-select-dropdown');

      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const filteredPacientes = pacientes.filter(p => 
          `${p.nombre} ${p.paterno}`.toLowerCase().includes(query)
        );
        
        dropdown.innerHTML = '';
        if (filteredPacientes.length > 0) {
          filteredPacientes.forEach(p => {
            const item = document.createElement('div');
            item.className = 'item';
            item.textContent = `${p.nombre} ${p.paterno} ${p.materno || ''}`;
            item.dataset.id = p.id_paciente;
            item.addEventListener('click', () => {
              searchInput.value = item.textContent;
              hiddenInput.value = item.dataset.id;
              dropdown.style.display = 'none';
            });
            dropdown.appendChild(item);
          });
        } else {
          dropdown.innerHTML = '<div class="empty">No se encontraron pacientes</div>';
        }
        dropdown.style.display = 'block';
      });

      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
    }
    
    function poblarSelectsModal() {
      const selectsData = [
          { ids: ['id_tipo_cirugia_crear', 'id_tipo_cirugia_editar'], data: tiposCirugia, map: t => `<option value="${t.id_tipo_cirugia}" data-horas="${t.horas}">${t.nombre}</option>` },
          { ids: ['id_quirofano_crear', 'id_quirofano_editar'], data: quirofanos, map: q => `<option value="${q.id_quirofano}">${q.nombre}</option>` },
          { ids: ['id_equipo_crear', 'id_equipo_editar'], data: equipos, map: e => `<option value="${e.id_equipo}">${e.nombre_equipo}</option>` }
      ];
      selectsData.forEach(s => {
          s.ids.forEach(id => {
              const select = document.getElementById(id);
              if(select) select.innerHTML = '<option value="">Seleccionar...</option>' + s.data.map(s.map).join('');
          });
      });
      
      setupSearchableSelect('paciente-search-crear-container');
      setupSearchableSelect('paciente-search-editar-container');
    }

    function generarHorasDisponibles() {
      const tipoSelect = document.getElementById('id_tipo_cirugia_crear');
      const quirofanoSelect = document.getElementById('id_quirofano_crear');
      if (!tipoSelect.value || !quirofanoSelect.value) return;

      const duracion = parseInt(tipoSelect.options[tipoSelect.selectedIndex].getAttribute('data-horas'));
      const horasContainer = document.getElementById('horas-disponibles-container');
      horasContainer.innerHTML = '';

      const idQuirofano = parseInt(quirofanoSelect.value);
      const cirugiasDelDia = cirugias.filter(c => 
          new Date(c.fecha_inicio).toDateString() === currentDate.toDateString() && c.id_quirofano === idQuirofano
      );

      const horasOcupadas = new Set();
      cirugiasDelDia.forEach(c => {
          const tipo = tiposCirugia.find(t => t.id_tipo_cirugia === c.id_tipo_cirugia);
          const duracionExistente = tipo ? tipo.horas : 1;
          const horaInicio = new Date(c.fecha_inicio).getHours();
          for (let i = 0; i < duracionExistente; i++) {
              horasOcupadas.add(horaInicio + i);
          }
      });
      
      for (let hora = 0; hora < 24; hora++) {
          let disponible = true;
          for (let i = 0; i < duracion; i++) {
              if (horasOcupadas.has(hora + i) || (hora + i) >= 24) {
                  disponible = false;
                  break;
              }
          }
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = `${hora}:00`;
          btn.disabled = !disponible;
          if(disponible) btn.onclick = () => seleccionarHora(hora);
          horasContainer.appendChild(btn);
      }
    }

    function seleccionarHora(hora) {
      const fecha = new Date(currentDate);
      fecha.setHours(hora, 0, 0, 0);
      document.getElementById('fecha_inicio_hidden').value = fecha.toISOString();
      document.getElementById('fecha-hora-seleccionada').textContent = fecha.toLocaleString('es-MX');
      
      // ======================================================
      // INICIO DE LA CORRECCI√ìN 1: Quitar 'required' al avanzar
      // ======================================================
      document.getElementById('id_tipo_cirugia_crear').required = false;
      document.getElementById('id_quirofano_crear').required = false;

      document.getElementById('id_paciente_crear').required = true;
      document.getElementById('id_equipo_crear').required = true;
      document.getElementById('motivo_crear').required = true;
      // ======================================================
      // FIN DE LA CORRECCI√ìN 1
      // ======================================================

      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
    }

    function volverAPaso1() {
      // ======================================================
      // INICIO DE LA CORRECCI√ìN 2: Devolver 'required' al retroceder
      // ======================================================
      document.getElementById('id_tipo_cirugia_crear').required = true;
      document.getElementById('id_quirofano_crear').required = true;

      document.getElementById('id_paciente_crear').required = false;
      document.getElementById('id_equipo_crear').required = false;
      document.getElementById('motivo_crear').required = false;
      // ======================================================
      // FIN DE LA CORRECCI√ìN 2
      // ======================================================

      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.remove('active');
    }
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const datePicker = document.getElementById('date-picker');
        datePicker.valueAsDate = new Date();
        datePicker.addEventListener('change', cargarDatos);
        
        document.getElementById('id_tipo_cirugia_crear').addEventListener('change', generarHorasDisponibles);
        document.getElementById('id_quirofano_crear').addEventListener('change', generarHorasDisponibles);

        // Listener para el formulario de CREACI√ìN
        document.getElementById('cirugia-form-crear').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Este bloque estaba mal formateado. Ahora cada campo est√° en su propia l√≠nea.
            const formData = {
                id_paciente: parseInt(document.getElementById('id_paciente_crear').value),
                id_quirofano: parseInt(document.getElementById('id_quirofano_crear').value),
                id_tipo_cirugia: parseInt(document.getElementById('id_tipo_cirugia_crear').value),
                id_equipo: parseInt(document.getElementById('id_equipo_crear').value),
                fecha_inicio: document.getElementById('fecha_inicio_hidden').value,
                motivo: document.getElementById('motivo_crear').value,
                estado: 'Programada'
            };
            const resultado = await CirugiasAPI.crear(formData);
            if (resultado) {
                alert('Cirug√≠a agendada correctamente');
                cerrarModalCirugia();
                cargarDatos();
            }
        });

        // Listener para el formulario de EDICI√ìN
        document.getElementById('cirugia-form-editar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('id_cirugia_editar').value;
            const fechaLocalEditarValue = document.getElementById('fecha_inicio_editar').value;
            if (!fechaLocalEditarValue) {
                alert("Error: La fecha y hora de inicio no pueden estar vac√≠as.");
                return;
            }
            const formData = {
                id_paciente: parseInt(document.getElementById('id_paciente_editar').value),
                id_quirofano: parseInt(document.getElementById('id_quirofano_editar').value),
                id_tipo_cirugia: parseInt(document.getElementById('id_tipo_cirugia_editar').value),
                id_equipo: parseInt(document.getElementById('id_equipo_editar').value),
                fecha_inicio: new Date(fechaLocalEditarValue).toISOString(),
                motivo: document.getElementById('motivo_editar').value,
                descripcion: document.getElementById('descripcion_editar').value || null,
                estado: document.getElementById('estado_editar').value
            };
            const resultado = await CirugiasAPI.actualizar(id, formData);
            if (resultado) {
                alert('Cirug√≠a actualizada correctamente');
                cerrarModalCirugia();
                cargarDatos();
            }
        });

        cargarDatos();
    });

  </script>
</body>
</html>